---
/**
 * 密码保护组件
 * 用于加密文章的密码验证和内容解密
 */
export interface Props {
  encryptedContent: string
  passwordHash: string
}

const { encryptedContent, passwordHash } = Astro.props
---

<div id="password-protection" class="password-protection">
  <div class="password-container">
    <div class="lock-icon">
      <svg
        width="48"
        height="48"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"
          fill="currentColor"></path>
      </svg>
    </div>
    <h2>内容已加密</h2>
    <p>请输入密码以查看此内容</p>
    <div class="password-input-group">
      <input
        type="password"
        id="password-input"
        placeholder="请输入密码"
        class="password-input"
      />
      <button id="unlock-btn" class="unlock-button">解锁</button>
    </div>
    <div id="error-message" class="error-message" style="display: none;">密码错误</div>
  </div>
</div>

<div id="decrypted-content" class="decrypted-content prose" style="display: none;"></div>

<style>
  .password-protection {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 40vh;
    padding: 2rem;
  }

  .password-container {
    text-align: center;
    max-width: 400px;
    width: 100%;
    padding: 2rem;
    border-radius: 12px;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .lock-icon {
    margin-bottom: 1rem;
    color: hsl(var(--primary));
  }

  .password-container h2 {
    margin-bottom: 0.5rem;
    color: hsl(var(--foreground));
    font-size: 1.5rem;
  }

  .password-container p {
    margin-bottom: 1.5rem;
    color: hsl(var(--muted-foreground));
  }

  .password-input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .password-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid hsl(var(--border));
    border-radius: 8px;
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }

  .password-input::placeholder {
    color: hsl(var(--muted-foreground));
  }

  .password-input:focus {
    outline: none;
    border-color: hsl(var(--primary));
  }

  .unlock-button {
    padding: 0.75rem 1.5rem;
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .unlock-button:hover {
    opacity: 0.9;
  }

  .unlock-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .error-message {
    color: hsl(var(--destructive, 0 84% 60%));
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .decrypted-content {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 移动端适配 */
  @media (max-width: 768px) {
    .password-protection {
      padding: 1rem;
      min-height: 30vh;
    }

    .password-container {
      padding: 1.5rem;
    }

    .password-input-group {
      flex-direction: column;
      gap: 0.75rem;
    }

    .password-input,
    .unlock-button {
      width: 100%;
    }
  }
</style>

<script define:vars={{ encryptedContent, passwordHash }}>
  // 动态加载 crypto-js
  async function loadCryptoJS() {
    if (typeof CryptoJS !== 'undefined') return

    return new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js'
      script.onload = resolve
      script.onerror = reject
      document.head.appendChild(script)
    })
  }

  // 动态加载 bcrypt
  async function loadBcrypt() {
    if (typeof dcodeIO !== 'undefined' && dcodeIO.bcrypt) return

    return new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js'
      script.onload = resolve
      script.onerror = reject
      document.head.appendChild(script)
    })
  }

  // 加载 marked 用于渲染 markdown
  async function loadMarked() {
    if (typeof marked !== 'undefined') return

    return new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js'
      script.onload = resolve
      script.onerror = reject
      document.head.appendChild(script)
    })
  }

  async function renderMarkdownContent(markdownText) {
    await loadMarked()

    const contentDiv = document.getElementById('decrypted-content')

    // 配置 marked
    marked.setOptions({
      breaks: true,
      gfm: true
    })

    const htmlContent = marked.parse(markdownText)
    contentDiv.innerHTML = htmlContent

    // 为代码块添加样式
    contentDiv.querySelectorAll('pre code').forEach((block) => {
      block.parentElement.classList.add('code-block')
    })
  }

  async function initPasswordProtection() {
    await Promise.all([loadCryptoJS(), loadBcrypt()])

    const passwordInput = document.getElementById('password-input')
    const unlockBtn = document.getElementById('unlock-btn')
    const errorMessage = document.getElementById('error-message')
    const protectionDiv = document.getElementById('password-protection')
    const contentDiv = document.getElementById('decrypted-content')

    async function attemptUnlock() {
      const inputPassword = passwordInput.value.trim()

      if (!inputPassword) {
        showError('请输入密码')
        return
      }

      unlockBtn.disabled = true
      unlockBtn.textContent = '验证中...'
      errorMessage.style.display = 'none'

      try {
        // 获取 bcrypt 实例
        const bcrypt = dcodeIO?.bcrypt || window.bcrypt

        // 验证密码
        const isPasswordCorrect = bcrypt.compareSync(inputPassword, passwordHash)

        if (!isPasswordCorrect) {
          showError('密码错误，请重试')
          return
        }

        // 解密内容
        const decryptedBytes = CryptoJS.AES.decrypt(encryptedContent, inputPassword)
        const decryptedContent = decryptedBytes.toString(CryptoJS.enc.Utf8)

        if (!decryptedContent) {
          showError('解密失败，请重试')
          return
        }

        // 渲染 markdown 内容
        await renderMarkdownContent(decryptedContent)
        protectionDiv.style.display = 'none'
        contentDiv.style.display = 'block'

        // 保存解锁状态到 sessionStorage
        sessionStorage.setItem('page-unlocked-' + window.location.pathname, 'true')
      } catch (error) {
        console.error('解密错误:', error)
        showError('解密过程出错，请重试')
      } finally {
        unlockBtn.disabled = false
        unlockBtn.textContent = '解锁'
      }
    }

    function showError(message) {
      errorMessage.textContent = message
      errorMessage.style.display = 'block'
      passwordInput.focus()
    }

    // 事件监听
    unlockBtn.addEventListener('click', attemptUnlock)
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        attemptUnlock()
      }
    })

    // 聚焦到密码输入框
    passwordInput.focus()
  }

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordProtection)
  } else {
    initPasswordProtection()
  }
</script>
